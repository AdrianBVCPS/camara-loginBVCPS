<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>CÁMARA LOGIN - Mobile</title>
    <!-- SDK de Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root {
            --primary-color: #D32F2F; --secondary-color: #9E9E9E; --light-grey: #E0E0E0;
            --dark-grey: #424242; --white: #FFFFFF; --accent-color: #1976D2;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--light-grey); color: var(--dark-grey); height: 100vh; overflow-x: hidden; touch-action: manipulation; }
        .header { background-color: var(--primary-color); color: var(--white); padding: 1rem; text-align: center; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); position: sticky; top: 0; z-index: 100; }
        .sidebar { background-color: var(--white); padding: 1rem; box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1); order: 2; max-height: 50vh; overflow-y: auto; }
        .main-content { flex: 1; display: flex; justify-content: center; align-items: center; background-color: var(--light-grey); order: 1; min-height: 50vh; position: relative; }
        .image-preview img, .image-preview canvas { max-width: 100%; max-height: 100%; object-fit: contain; display: block; }
        #canvas { display: none; }
        .placeholder { padding: 2rem; color: var(--secondary-color); text-align: center; }
        .form-group { margin-bottom: 1rem; }
        .channel-group { border: 2px solid var(--accent-color); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem; }
        input[type="text"], input[type="number"], select { width: 100%; padding: 0.75rem; border: 1px solid var(--secondary-color); border-radius: 8px; font-size: 1rem; }
        input[type="file"] { display: none; }
        .file-upload { background-color: var(--dark-grey); color: var(--white); padding: 0.75rem; text-align: center; border-radius: 8px; cursor: pointer; transition: all 0.3s; width: 100%; }
        .btn { display: block; width: 100%; padding: 0.75rem; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; transition: all 0.3s; margin-top: 0.5rem; }
        .btn-primary { background-color: var(--primary-color); color: var(--white); }
        .btn-secondary { background-color: var(--accent-color); color: var(--white); }
        .btn:disabled { background-color: var(--secondary-color); cursor: not-allowed; transform: none; }
    </style>
</head>
<body>
    <div class="header"><h1>APLICACIÓN CÁMARA LOGIN BUREAU VERITAS CPS LUGO</h1></div>
    <div class="container">
        <div class="sidebar">
            <!-- SECCIÓN DE CONEXIÓN -->
            <div class="channel-group">
                <label for="channelId">Código de Sala (4 dígitos):</label>
                <input type="number" id="channelId" placeholder="Ej: 1234" maxlength="4" oninput="if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);">
                <button id="connectBtn" class="btn btn-secondary">Conectar a Sala</button>
                <div id="status" style="font-size: 0.8rem; margin-top: 0.5rem; text-align: center;">Desconectado</div>
            </div>

            <label for="fileInput" class="file-upload touch-target">📷 CAPTURAR IMAGEN</label>
            <input type="file" id="fileInput" accept="image/*" capture="environment">
            <div id="fileName" class="filename" style="font-size: 0.8rem; margin-top: 0.5rem; word-break: break-all;">No se ha seleccionado ninguna imagen</div>

            <!-- Botón para enviar la imagen al canal -->
            <button id="sendBtn" class="btn btn-primary" disabled>📲 Enviar a Ordenador</button>
            
            <hr style="margin: 1.5rem 0;">

            <!-- Controles de edición (se ocultan hasta tener imagen) -->
            <div id="editControls" style="display:none;">
                <div class="form-group">
                    <label for="textInput">Texto a añadir:</label>
                    <input type="text" id="textInput" placeholder="REQUEST" autocomplete="off">
                </div>
                <button id="downloadBtn" class="btn btn-primary" disabled>💾 Descargar Imagen</button>
            </div>
        </div>
        <div class="main-content">
            <div class="image-preview">
                <img id="previewImage" style="display: none;" />
                <canvas id="canvas"></canvas>
                <div class="placeholder" id="placeholderText">
                    <p>Introduce un código de sala y pulsa "Conectar"</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
    // --- TU CONFIGURACIÓN DE FIREBASE YA INTEGRADA ---
    const firebaseConfig = {
      apiKey: "AIzaSyAbahVsQxI_HOz_yPtDlp4hXSdZO0dvRl4",
      authDomain: "camara-app-lugo.firebaseapp.com",
      databaseURL: "https://camara-app-lugo-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "camara-app-lugo",
      storageBucket: "camara-app-lugo.appspot.com",
      messagingSenderId: "437448426207",
      appId: "1:437448426207:web:a9dbecc8cbdb77d0c4df6a",
      measurementId: "G-HXTN98NTPS"
    };
    // --------------------------------------------------------

    // Inicializa Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Referencias a elementos DOM
    const channelIdInput = document.getElementById('channelId');
    const connectBtn = document.getElementById('connectBtn');
    const statusDiv = document.getElementById('status');
    const fileInput = document.getElementById('fileInput');
    const fileName = document.getElementById('fileName');
    const sendBtn = document.getElementById('sendBtn');
    const editControls = document.getElementById('editControls');
    const textInput = document.getElementById('textInput');
    const downloadBtn = document.getElementById('downloadBtn');
    const previewImage = document.getElementById('previewImage');
    const placeholderText = document.getElementById('placeholderText');
    const canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d');
    
    let currentImage = null;
    let currentChannelRef = null;

    function setUIState(isConnected, isLoading = false) {
        channelIdInput.disabled = isConnected || isLoading;
        connectBtn.disabled = isLoading;
        connectBtn.textContent = isConnected ? 'Desconectar' : 'Conectar a Sala';
        statusDiv.textContent = isLoading ? 'Conectando...' : (isConnected ? `Conectado a sala: ${channelIdInput.value}` : 'Desconectado');
        statusDiv.style.color = isConnected ? 'green' : 'red';
        
        const hasImage = !!currentImage;
        sendBtn.disabled = !isConnected || !hasImage;
        downloadBtn.disabled = !hasImage;
        editControls.style.display = hasImage ? 'block' : 'none';
        placeholderText.style.display = hasImage ? 'none' : 'block';
        if (!hasImage && !isConnected) {
            placeholderText.textContent = 'Introduce un código de sala y pulsa "Conectar"';
        } else if (!hasImage && isConnected) {
            placeholderText.textContent = 'Captura una imagen para enviarla';
        }
    }

    function connectToChannel() {
        const channelId = channelIdInput.value;
        if (!channelId || channelId.length !== 4) {
            alert("Por favor, introduce un código de sala de 4 dígitos.");
            return;
        }

        if (currentChannelRef) {
            currentChannelRef.off(); 
            currentChannelRef = null;
            setUIState(false);
            return;
        }
        
        setUIState(false, true);

        currentChannelRef = database.ref('channels/' + channelId);
        currentChannelRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data && data.imageData) {
                if (currentImage !== data.imageData) { // Evita recargar la misma imagen
                    currentImage = data.imageData;
                    fileName.textContent = data.fileName || 'Imagen recibida';
                    processAndDisplayImage();
                    alert("¡Nueva imagen recibida!");
                }
            }
            if(!statusDiv.textContent.includes('Conectado')) {
                 setUIState(true);
            }
        }, (error) => {
            alert("Error de conexión con la base de datos: " + error.message);
            setUIState(false);
        });
    }

    function sendImageToChannel() {
        if (!currentChannelRef || !currentImage) return;

        alert("Enviando imagen al ordenador...");
        sendBtn.disabled = true;

        canvas.toBlob(blob => {
            const reader = new FileReader();
            reader.onload = function(event) {
                const imageData = event.target.result;
                currentChannelRef.set({
                    imageData: imageData,
                    fileName: fileName.textContent,
                    timestamp: Date.now()
                }).then(() => {
                    alert("¡Imagen enviada con éxito!");
                    sendBtn.disabled = false;
                }).catch(error => {
                    alert("Error al enviar la imagen: " + error.message);
                    sendBtn.disabled = false;
                });
            };
            reader.readAsDataURL(blob);
        }, 'image/jpeg', 0.9);
    }

    function processAndDisplayImage() {
        if (!currentImage) {
            setUIState(!!currentChannelRef);
            return;
        }
        const img = new Image();
        img.onload = () => {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            
            const text = textInput.value;
            if (text.trim()) {
                const fontSize = Math.max(48, canvas.width / 25); // Tamaño de fuente dinámico
                ctx.font = `bold ${fontSize}px Arial`;
                ctx.fillStyle = 'white';
                ctx.strokeStyle = 'black';
                ctx.lineWidth = Math.max(2, fontSize / 20);
                const padding = fontSize;
                ctx.strokeText(text, padding, canvas.height - padding);
                ctx.fillText(text, padding, canvas.height - padding);
            }
            
            previewImage.style.display = 'block';
            previewImage.src = canvas.toDataURL('image/png');
            setUIState(!!currentChannelRef);
        };
        img.src = currentImage;
    }

    connectBtn.addEventListener('click', connectToChannel);
    sendBtn.addEventListener('click', sendImageToChannel);
    
    fileInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = e => {
                currentImage = e.target.result;
                fileName.textContent = file.name || `captura_${Date.now()}.jpg`;
                processAndDisplayImage();
            };
            reader.readAsDataURL(file);
        }
    });

    textInput.addEventListener('input', processAndDisplayImage);

    downloadBtn.addEventListener('click', () => {
        const link = document.createElement('a');
        link.download = (fileName.textContent || 'imagen_editada').replace(/\.[^/.]+$/, "") + ".png";
        link.href = canvas.toDataURL('image/png');
        link.click();
    });

    setUIState(false);
    </script>
</body>
</html>
